---
title: "ä¸Šä¸‹æ–‡å‹ç¼©: ç¨³å®šé•¿ä¼šè¯ | Antigravity-Manager"
sidebarTitle: "é•¿ä¼šè¯ä¸å´©"
subtitle: "ä¸Šä¸‹æ–‡å‹ç¼©: ç¨³å®šé•¿ä¼šè¯"
description: "å­¦ä¹  Antigravity çš„ä¸‰å±‚ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ã€‚é€šè¿‡å·¥å…·è½®è£å‰ªã€Thinking å‹ç¼©ä¸ç­¾åç¼“å­˜é™ä½ 400 é”™è¯¯ä¸ Prompt è¿‡é•¿å¤±è´¥ã€‚"
tags:
  - "ä¸Šä¸‹æ–‡å‹ç¼©"
  - "ç­¾åç¼“å­˜"
  - "Thinking"
  - "Tool Result"
  - "ç¨³å®šæ€§"
prerequisite:
  - "start-proxy-and-first-client"
  - "advanced-monitoring"
order: 8
---

# é•¿ä¼šè¯ç¨³å®šæ€§ï¼šä¸Šä¸‹æ–‡å‹ç¼©ã€ç­¾åç¼“å­˜ä¸å·¥å…·ç»“æœå‹ç¼©

ä½ åœ¨ç”¨ Claude Code / Cherry Studio ä¹‹ç±»çš„å®¢æˆ·ç«¯è·‘é•¿ä¼šè¯æ—¶ï¼Œæœ€çƒ¦çš„ä¸æ˜¯æ¨¡å‹ä¸å¤Ÿèªæ˜ï¼Œè€Œæ˜¯å¯¹è¯è·‘ç€è·‘ç€çªç„¶å¼€å§‹æŠ¥é”™ï¼š`Prompt is too long`ã€400 ç­¾åé”™è¯¯ã€å·¥å…·è°ƒç”¨é“¾æ–­äº†ã€æˆ–è€…å·¥å…·å¾ªç¯è¶Šè·‘è¶Šå¡ã€‚

è¿™ä¸€è¯¾æŠŠ Antigravity Tools ä¸ºè¿™äº›é—®é¢˜åšçš„ä¸‰ä»¶äº‹è®²æ¸…æ¥šï¼šä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆåˆ†ä¸‰å±‚é€æ­¥ä»‹å…¥ï¼‰ã€ç­¾åç¼“å­˜ï¼ˆæŠŠ Thinking çš„ç­¾åé“¾ç»­ä¸Šï¼‰ã€å·¥å…·ç»“æœå‹ç¼©ï¼ˆé¿å…å·¥å…·è¾“å‡ºæŠŠä¸Šä¸‹æ–‡å¡çˆ†ï¼‰ã€‚

## å­¦å®Œä½ èƒ½åšä»€ä¹ˆ

- è¯´æ¸…æ¥šä¸‰å±‚æ¸è¿›å¼ä¸Šä¸‹æ–‡å‹ç¼©åˆ†åˆ«åœ¨åšä»€ä¹ˆã€å„è‡ªçš„ä»£ä»·æ˜¯ä»€ä¹ˆ
- çŸ¥é“ç­¾åç¼“å­˜å­˜äº†å“ªäº›ä¸œè¥¿ï¼ˆTool/Family/Session ä¸‰å±‚ï¼‰ä»¥åŠ 2 å°æ—¶ TTL çš„å½±å“
- ç†è§£å·¥å…·ç»“æœå‹ç¼©çš„è§„åˆ™ï¼šä½•æ—¶ä¼šä¸¢æ‰ base64 å›¾ç‰‡ã€ä½•æ—¶ä¼šæŠŠæµè§ˆå™¨å¿«ç…§å˜æˆå¤´+å°¾æ‘˜è¦
- éœ€è¦æ—¶èƒ½é€šè¿‡ `proxy.experimental` çš„é˜ˆå€¼å¼€å…³è°ƒèŠ‚å‹ç¼©è§¦å‘æ—¶æœº

## ä½ ç°åœ¨çš„å›°å¢ƒ

- é•¿å¯¹è¯åçªç„¶å¼€å§‹ 400ï¼šçœ‹èµ·æ¥åƒç­¾åå¤±æ•ˆï¼Œä½†ä½ ä¸çŸ¥é“ç­¾åä»å“ªæ¥ã€ä¸¢åœ¨å“ª
- å·¥å…·è°ƒç”¨è¶Šæ¥è¶Šå¤šï¼Œå†å² tool_result å †åˆ°ä¸Šæ¸¸ç›´æ¥æ‹’ç»ï¼ˆæˆ–å˜å¾—ææ…¢ï¼‰
- ä½ æƒ³ç”¨å‹ç¼©æ•‘åœºï¼Œä½†åˆæ‹…å¿ƒç ´å Prompt Cacheã€å½±å“ä¸€è‡´æ€§æˆ–è®©æ¨¡å‹ä¸¢ä¿¡æ¯

## ä»€ä¹ˆæ—¶å€™ç”¨è¿™ä¸€æ‹›

- ä½ åœ¨è·‘é•¿é“¾è·¯å·¥å…·ä»»åŠ¡ï¼ˆæœç´¢/è¯»æ–‡ä»¶/æµè§ˆå™¨å¿«ç…§/å¤šè½®å·¥å…·å¾ªç¯ï¼‰
- ä½ åœ¨ç”¨ Thinking æ¨¡å‹åšå¤æ‚æ¨ç†ï¼Œä¸”ä¼šè¯ç»å¸¸è¶…è¿‡å‡ åè½®
- ä½ åœ¨æ’æŸ¥å®¢æˆ·ç«¯èƒ½å¤ç°ä½†ä½ è¯´ä¸æ¸…ä¸ºä»€ä¹ˆçš„ç¨³å®šæ€§é—®é¢˜

## ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡å‹ç¼©

**ä¸Šä¸‹æ–‡å‹ç¼©**æ˜¯ä»£ç†åœ¨æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡å‹åŠ›è¿‡é«˜æ—¶ï¼Œå¯¹å†å²æ¶ˆæ¯åšçš„è‡ªåŠ¨é™å™ªä¸ç˜¦èº«ï¼šå…ˆè£æ‰æ—§çš„å·¥å…·è½®ï¼Œå†æŠŠæ—§çš„ Thinking æ–‡æœ¬å‹æˆå ä½ç¬¦ä½†ä¿ç•™ç­¾åï¼Œæœ€ååœ¨æç«¯æƒ…å†µä¸‹ç”Ÿæˆ XML æ‘˜è¦å¹¶ Fork ä¸€ä¸ªæ–°ä¼šè¯ç»§ç»­å¯¹è¯ï¼Œä»è€Œé™ä½ `Prompt is too long` å’Œç­¾åé“¾æ–­è£‚å¯¼è‡´çš„å¤±è´¥ã€‚

::: info ä¸Šä¸‹æ–‡å‹åŠ›æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Ÿ
Claude å¤„ç†å™¨ä¼šç”¨ `ContextManager::estimate_token_usage()` åšä¸€ä¸ªè½»é‡ä¼°ç®—ï¼Œå¹¶ç”¨ `estimation_calibrator` æ ¡å‡†ï¼Œç„¶åç”¨ `usage_ratio = estimated_usage / context_limit` å¾—åˆ°å‹åŠ›ç™¾åˆ†æ¯”ï¼ˆæ—¥å¿—é‡Œä¼šæ‰“å° raw/calibrated å€¼ï¼‰ã€‚
:::

## ğŸ’ å¼€å§‹å‰çš„å‡†å¤‡

- ä½ å·²ç»è·‘é€šæœ¬åœ°ä»£ç†ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯ç¡®å®åœ¨èµ° `/v1/messages` è¿™æ¡é“¾è·¯ï¼ˆè§å¯åŠ¨æœ¬åœ°åä»£å¹¶æ¥å…¥ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼‰
- ä½ èƒ½æŸ¥çœ‹ä»£ç†æ—¥å¿—ï¼ˆå¼€å‘è€…è°ƒè¯•æˆ–æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼‰ã€‚ä»“åº“é‡Œçš„æµ‹è¯•æ–¹æ¡ˆç»™äº†ä¸€ä¸ªç¤ºä¾‹æ—¥å¿—è·¯å¾„ä¸ grep æ–¹å¼ï¼ˆè§ `docs/testing/context_compression_test_plan.md`ï¼‰

::: tip é…åˆ Proxy Monitor æ›´å¥½å®šä½
å¦‚æœä½ è¦æŠŠå‹ç¼©è§¦å‘ä¸å“ªç±»è¯·æ±‚/å“ªä¸ªè´¦å·/å“ªè½®å·¥å…·è°ƒç”¨å¯¹ä¸Šå·ï¼Œå»ºè®®åŒæ—¶å¼€ç€ Proxy Monitorã€‚
:::

## æ ¸å¿ƒæ€è·¯

è¿™å¥—ç¨³å®šæ€§è®¾è®¡ä¸æ˜¯ç›´æ¥æŠŠå†å²å…¨åˆ äº†ï¼Œè€Œæ˜¯æŒ‰ä»£ä»·ä»ä½åˆ°é«˜é€å±‚ä»‹å…¥ï¼š

| å±‚çº§ | è§¦å‘ç‚¹ï¼ˆå¯é…ç½®ï¼‰ | åšäº†ä»€ä¹ˆ | ä»£ä»·/å‰¯ä½œç”¨ |
| --- | --- | --- | --- |
| Layer 1 | `proxy.experimental.context_compression_threshold_l1`ï¼ˆé»˜è®¤ 0.4ï¼‰ | è¯†åˆ«å·¥å…·è½®ï¼Œåªä¿ç•™æœ€è¿‘ N è½®ï¼ˆä»£ç é‡Œæ˜¯ 5ï¼‰ï¼ŒæŠŠæ›´æ—©çš„ tool_use/tool_result å¯¹åˆ æ‰ | ä¸æ”¹å‰©ä½™æ¶ˆæ¯å†…å®¹ï¼Œå¯¹ Prompt Cache æ›´å‹å¥½ |
| Layer 2 | `proxy.experimental.context_compression_threshold_l2`ï¼ˆé»˜è®¤ 0.55ï¼‰ | æŠŠæ—§çš„ Thinking æ–‡æœ¬å‹æˆ `"..."`ï¼Œä½†ä¿ç•™ `signature`ï¼Œå¹¶ä¿æŠ¤æœ€è¿‘ 4 æ¡æ¶ˆæ¯ä¸åŠ¨ | ä¼šä¿®æ”¹å†å²å†…å®¹ï¼Œæ³¨é‡Šé‡Œæ˜ç¡®ä¼š break cacheï¼Œä½†èƒ½ä¿ä½ç­¾åé“¾ |
| Layer 3 | `proxy.experimental.context_compression_threshold_l3`ï¼ˆé»˜è®¤ 0.7ï¼‰ | è°ƒç”¨åå°æ¨¡å‹ç”Ÿæˆ XML æ‘˜è¦ï¼Œç„¶å Fork ä¸€ä¸ªæ–°æ¶ˆæ¯åºåˆ—ç»§ç»­å¯¹è¯ | ä¾èµ–åå°æ¨¡å‹è°ƒç”¨ï¼›è‹¥å¤±è´¥ä¼šè¿”å› 400ï¼ˆæœ‰å‹å¥½æç¤ºï¼‰ |

æ¥ä¸‹æ¥æŒ‰ä¸‰å±‚æ‹†å¼€è®²ï¼Œé¡ºä¾¿æŠŠç­¾åç¼“å­˜å’Œå·¥å…·ç»“æœå‹ç¼©æ”¾åœ¨ä¸€èµ·ã€‚

### Layer 1ï¼šå·¥å…·è½®è£å‰ªï¼ˆTrim Tool Messagesï¼‰

Layer 1 çš„å…³é”®ç‚¹æ˜¯åªåˆ æ•´è½®å·¥å…·äº¤äº’ï¼Œé¿å…åŠåˆ å¯¼è‡´ä¸Šä¸‹æ–‡ä¸ä¸€è‡´ã€‚

- ä¸€è½®å·¥å…·äº¤äº’çš„è¯†åˆ«è§„åˆ™åœ¨ `identify_tool_rounds()`ï¼š`assistant` é‡Œå‡ºç° `tool_use` å¼€å§‹ä¸€è½®ï¼Œåç»­ `user` é‡Œå‡ºç° `tool_result` ä»ç®—è¿™ä¸€è½®ï¼Œç›´åˆ°é‡åˆ°æ™®é€š user æ–‡æœ¬ç»“æŸè¿™ä¸€è½®ã€‚
- çœŸæ­£æ‰§è¡Œè£å‰ªçš„æ˜¯ `ContextManager::trim_tool_messages(&mut messages, 5)`ï¼šå½“å†å²å·¥å…·è½®è¶…è¿‡ 5 è½®æ—¶ï¼Œåˆ æ‰æ›´æ—©çš„è½®æ¬¡é‡Œæ¶‰åŠçš„æ¶ˆæ¯ã€‚

### Layer 2ï¼šThinking å‹ç¼©ä½†ä¿ç•™ç­¾å

å¾ˆå¤š 400 é—®é¢˜å¹¶ä¸æ˜¯ Thinking å¤ªé•¿ï¼Œè€Œæ˜¯ Thinking çš„ç­¾åé“¾æ–­äº†ã€‚Layer 2 çš„ç­–ç•¥æ˜¯ï¼š

- åªå¤„ç† `assistant` æ¶ˆæ¯é‡Œçš„ `ContentBlock::Thinking { thinking, signature, .. }`
- åªæœ‰åœ¨ `signature.is_some()` ä¸” `thinking.len() > 10` æ—¶æ‰å‹ç¼©ï¼ŒæŠŠ `thinking` ç›´æ¥æ”¹æˆ `"..."`
- æœ€è¿‘ `protected_last_n = 4` æ¡æ¶ˆæ¯ä¸å‹ç¼©ï¼ˆå¤§è‡´æ˜¯æœ€è¿‘ 2 è½® user/assistantï¼‰

è¿™æ ·å¯ä»¥çœæ‰å¤§é‡ Tokenï¼Œä½†ä»æŠŠ `signature` ç•™åœ¨å†å²é‡Œï¼Œé¿å…å·¥å…·é“¾éœ€è¦å›å¡«ç­¾åæ—¶æ— ä»æ¢å¤ã€‚

### Layer 3ï¼šFork + XML æ‘˜è¦ï¼ˆæé™å…œåº•ï¼‰

å½“å‹åŠ›ç»§ç»­å‡é«˜æ—¶ï¼ŒClaude å¤„ç†å™¨ä¼šå°è¯•é‡å¼€ä¼šè¯ä½†ä¸ä¸¢å…³é”®ä¿¡æ¯ï¼š

1. ä»åŸå§‹æ¶ˆæ¯é‡Œæå–æœ€åä¸€ä¸ªæœ‰æ•ˆçš„ Thinking ç­¾åï¼ˆ`ContextManager::extract_last_valid_signature()`ï¼‰
2. æŠŠæ•´ä¸ªå†å² + `CONTEXT_SUMMARY_PROMPT` æ‹¼æˆä¸€ä¸ªç”Ÿæˆ XML æ‘˜è¦çš„è¯·æ±‚ï¼Œæ¨¡å‹å›ºå®šä¸º `BACKGROUND_MODEL_LITE`ï¼ˆå½“å‰ä»£ç æ˜¯ `gemini-2.5-flash`ï¼‰
3. æ‘˜è¦é‡Œè¦æ±‚åŒ…å« `<latest_thinking_signature>`ï¼Œç”¨äºåç»­ç­¾åé“¾å»¶ç»­
4. Fork å‡ºä¸€ä¸ªæ–°æ¶ˆæ¯åºåˆ—ï¼š
   - `User: Context has been compressed... + XML summary`
   - `Assistant: I have reviewed...`
   - å†é™„ä¸ŠåŸè¯·æ±‚æœ€åä¸€æ¡ user æ¶ˆæ¯ï¼ˆå¦‚æœå®ƒä¸æ˜¯åˆšåˆšçš„æ‘˜è¦æŒ‡ä»¤ï¼‰

å¦‚æœ Fork + æ‘˜è¦å¤±è´¥ï¼Œä¼šç›´æ¥è¿”å› `StatusCode::BAD_REQUEST`ï¼Œå¹¶æç¤ºä½ ç”¨ `/compact` æˆ– `/clear` ç­‰æ–¹å¼æ‰‹åŠ¨å¤„ç†ï¼ˆè§å¤„ç†å™¨è¿”å›çš„ error JSONï¼‰ã€‚

### æ—è·¯ 1ï¼šä¸‰å±‚ç­¾åç¼“å­˜ï¼ˆTool / Family / Sessionï¼‰

ç­¾åç¼“å­˜æ˜¯ä¸Šä¸‹æ–‡å‹ç¼©çš„ä¿é™©ä¸ï¼Œå°¤å…¶æ˜¯å®¢æˆ·ç«¯ä¼šè£å‰ª/ä¸¢å¼ƒç­¾åå­—æ®µæ—¶ã€‚

- TTLï¼š`SIGNATURE_TTL = 2 * 60 * 60`ï¼ˆ2 å°æ—¶ï¼‰
- Layer 1ï¼š`tool_use_id -> signature`ï¼ˆå·¥å…·é“¾æ¢å¤ï¼‰
- Layer 2ï¼š`signature -> model family`ï¼ˆè·¨æ¨¡å‹å…¼å®¹æ€§æ£€æŸ¥ï¼Œé¿å… Claude ç­¾åè¢«å¸¦åˆ° Gemini å®¶æ—æ¨¡å‹ä¸Šï¼‰
- Layer 3ï¼š`session_id -> latest signature`ï¼ˆä¼šè¯çº§éš”ç¦»ï¼Œé¿å…ä¸åŒå¯¹è¯æ±¡æŸ“ï¼‰

è¿™ä¸‰å±‚ç¼“å­˜ä¼šåœ¨ Claude SSE æµå¼è§£æä¸è¯·æ±‚è½¬æ¢æ—¶è¢«å†™å…¥/è¯»å–ï¼š

- æµå¼è§£æåˆ° thinking çš„ `signature` ä¼šå†™å…¥ Session Cacheï¼ˆä»¥åŠç¼“å­˜ familyï¼‰
- æµå¼è§£æåˆ° tool_use çš„ `signature` ä¼šå†™å…¥ Tool Cache + Session Cache
- åœ¨æŠŠ Claude å·¥å…·è°ƒç”¨è½¬æ¢ä¸º Gemini `functionCall` æ—¶ï¼Œä¼šä¼˜å…ˆä» Session Cache æˆ– Tool Cache æŠŠç­¾åè¡¥å›å»

### æ—è·¯ 2ï¼šå·¥å…·ç»“æœå‹ç¼©ï¼ˆTool Result Compressorï¼‰

å·¥å…·ç»“æœå¾€å¾€æ¯”èŠå¤©æ–‡æœ¬æ›´å®¹æ˜“æŠŠä¸Šä¸‹æ–‡å¡çˆ†ï¼Œæ‰€ä»¥è¯·æ±‚è½¬æ¢é˜¶æ®µä¼šå¯¹ tool_result åšå¯é¢„æœŸçš„åˆ å‡ã€‚

æ ¸å¿ƒè§„åˆ™ï¼ˆéƒ½åœ¨ `tool_result_compressor.rs`ï¼‰ï¼š

- æ€»å­—ç¬¦ä¸Šé™ï¼š`MAX_TOOL_RESULT_CHARS = 200_000`
- base64 å›¾ç‰‡å—ç›´æ¥ç§»é™¤ï¼ˆè¿½åŠ ä¸€æ®µæç¤ºæ–‡æœ¬ï¼‰
- å¦‚æœæ£€æµ‹åˆ°è¾“å‡ºå·²ä¿å­˜åˆ°æ–‡ä»¶çš„æç¤ºï¼Œä¼šæå–å…³é”®ä¿¡æ¯å¹¶ç”¨ `[tool_result omitted ...]` å ä½
- å¦‚æœæ£€æµ‹åˆ°æµè§ˆå™¨å¿«ç…§ï¼ˆåŒ…å« `page snapshot` / `ref=` ç­‰ç‰¹å¾ï¼‰ï¼Œä¼šæ”¹æˆå¤´ + å°¾æ‘˜è¦ï¼Œå¹¶æ ‡æ³¨çœç•¥äº†å¤šå°‘å­—ç¬¦
- å¦‚æœè¾“å…¥åƒ HTMLï¼Œä¼šå…ˆç§»é™¤ `<style>`/`<script>`/base64 ç‰‡æ®µå†åšæˆªæ–­

## è·Ÿæˆ‘åš

### ç¬¬ 1 æ­¥ï¼šç¡®è®¤å‹ç¼©é˜ˆå€¼ï¼ˆä»¥åŠé»˜è®¤å€¼ï¼‰

**ä¸ºä»€ä¹ˆ**
å‹ç¼©è§¦å‘ç‚¹ä¸æ˜¯å†™æ­»çš„ï¼Œæ¥è‡ª `proxy.experimental.*`ã€‚ä½ å¾—å…ˆçŸ¥é“å½“å‰é˜ˆå€¼ï¼Œæ‰èƒ½åˆ¤æ–­ä¸ºä»€ä¹ˆå®ƒè¿™ä¹ˆæ—©/è¿™ä¹ˆæ™šæ‰ä»‹å…¥ã€‚

é»˜è®¤å€¼ï¼ˆRust ä¾§ `ExperimentalConfig::default()`ï¼‰ï¼š

```json
{
  "proxy": {
    "experimental": {
      "enable_signature_cache": true,
      "enable_tool_loop_recovery": true,
      "enable_cross_model_checks": true,
      "enable_usage_scaling": true,
      "context_compression_threshold_l1": 0.4,
      "context_compression_threshold_l2": 0.55,
      "context_compression_threshold_l3": 0.7
    }
  }
}
```

**ä½ åº”è¯¥çœ‹åˆ°**ï¼šä½ çš„é…ç½®é‡Œå­˜åœ¨ `proxy.experimental`ï¼ˆå­—æ®µåä¸ä¸Šé¢ä¸€è‡´ï¼‰ï¼Œå¹¶ä¸”é˜ˆå€¼æ˜¯ `0.x` è¿™æ ·çš„æ¯”ä¾‹å€¼ã€‚

::: warning é…ç½®æ–‡ä»¶ä½ç½®ä¸åœ¨è¿™ä¸€è¯¾é‡å¤è®²
é…ç½®æ–‡ä»¶çš„è½ç›˜ä½ç½®ä¸ä¿®æ”¹åæ˜¯å¦éœ€è¦é‡å¯ï¼Œå±äºé…ç½®ç®¡ç†èŒƒç•´ã€‚æŒ‰è¿™å¥—æ•™ç¨‹ä½“ç³»ï¼Œä¼˜å…ˆä»¥é…ç½®å…¨è§£ï¼šAppConfig/ProxyConfigã€è½ç›˜ä½ç½®ä¸çƒ­æ›´æ–°è¯­ä¹‰ä¸ºå‡†ã€‚
:::

### ç¬¬ 2 æ­¥ï¼šç”¨æ—¥å¿—ç¡®è®¤ Layer 1/2/3 æ˜¯å¦è§¦å‘

**ä¸ºä»€ä¹ˆ**
è¿™ä¸‰å±‚éƒ½æ˜¯ä»£ç†å†…éƒ¨è¡Œä¸ºï¼Œæœ€å¯é çš„éªŒè¯æ–¹å¼æ˜¯çœ‹æ—¥å¿—é‡Œæ˜¯å¦å‡ºç° `[Layer-1]` / `[Layer-2]` / `[Layer-3]`ã€‚

ä»“åº“çš„æµ‹è¯•æ–¹æ¡ˆç»™äº†ä¸€ä¸ªç¤ºä¾‹å‘½ä»¤ï¼ˆæŒ‰éœ€è°ƒæ•´ä¸ºä½ æœºå™¨ä¸Šçš„å®é™…æ—¥å¿—è·¯å¾„ï¼‰ï¼š

```bash
tail -f ~/Library/Application\ Support/com.antigravity.tools/logs/antigravity.log | grep -E "Layer-[123]"
```

**ä½ åº”è¯¥çœ‹åˆ°**ï¼šå½“å‹åŠ›å‡é«˜æ—¶ï¼Œæ—¥å¿—å‡ºç°ç±»ä¼¼ `Tool trimming triggered`ã€`Thinking compression triggered`ã€`Fork successful` çš„è®°å½•ï¼ˆå…·ä½“å­—æ®µä»¥æ—¥å¿—åŸæ–‡ä¸ºå‡†ï¼‰ã€‚

### ç¬¬ 3 æ­¥ï¼šç†è§£å‡€åŒ–å’Œå‹ç¼©çš„å·®åˆ«ï¼ˆä¸è¦æ··ç”¨é¢„æœŸï¼‰

**ä¸ºä»€ä¹ˆ**
æœ‰äº›é—®é¢˜ï¼ˆæ¯”å¦‚å¼ºåˆ¶é™çº§åˆ°ä¸æ”¯æŒ Thinking çš„æ¨¡å‹ï¼‰éœ€è¦å‡€åŒ–è€Œä¸æ˜¯å‹ç¼©ã€‚å‡€åŒ–ä¼šç›´æ¥åˆ æ‰ Thinking blockï¼›å‹ç¼©ä¼šä¿ç•™ç­¾åé“¾ã€‚

åœ¨ Claude å¤„ç†å™¨é‡Œï¼Œåå°ä»»åŠ¡é™çº§ä¼šèµ° `ContextManager::purify_history(..., PurificationStrategy::Aggressive)`ï¼Œå®ƒä¼šæŠŠå†å² Thinking block ç›´æ¥ç§»é™¤ã€‚

**ä½ åº”è¯¥çœ‹åˆ°**ï¼šä½ èƒ½åŒºåˆ†ä¸¤ç±»è¡Œä¸ºï¼š

- å‡€åŒ–æ˜¯åˆ æ‰ Thinking block
- Layer 2 å‹ç¼©æ˜¯æŠŠæ—§ Thinking æ–‡æœ¬æ›¿æ¢æˆ `"..."`ï¼Œä½†ç­¾åè¿˜åœ¨

### ç¬¬ 4 æ­¥ï¼šå½“ä½ é‡åˆ° 400 ç­¾åé”™è¯¯ï¼Œå…ˆçœ‹ Session Cache æ˜¯å¦å‘½ä¸­

**ä¸ºä»€ä¹ˆ**
å¾ˆå¤š 400 çš„æ ¹å› ä¸æ˜¯æ²¡æœ‰ç­¾åï¼Œè€Œæ˜¯ç­¾åæ²¡è·Ÿç€æ¶ˆæ¯èµ°ã€‚è¯·æ±‚è½¬æ¢æ—¶ä¼šä¼˜å…ˆä» Session Cache è¡¥ç­¾åã€‚

çº¿ç´¢ï¼ˆè¯·æ±‚è½¬æ¢é˜¶æ®µçš„æ—¥å¿—ä¼šæç¤ºä» SESSION/TOOL cache æ¢å¤ç­¾åï¼‰ï¼š

- `[Claude-Request] Recovered signature from SESSION cache ...`
- `[Claude-Request] Recovered signature from TOOL cache ...`

**ä½ åº”è¯¥çœ‹åˆ°**ï¼šå½“å®¢æˆ·ç«¯ä¸¢ç­¾åä½†ä»£ç†ç¼“å­˜è¿˜åœ¨æ—¶ï¼Œæ—¥å¿—é‡Œä¼šå‡ºç° Recovered signature from ... cache çš„è®°å½•ã€‚

### ç¬¬ 5 æ­¥ï¼šç†è§£å·¥å…·ç»“æœå‹ç¼©çš„ä¼šä¸¢ä»€ä¹ˆ

**ä¸ºä»€ä¹ˆ**
å¦‚æœä½ è®©å·¥å…·æŠŠå¤§æ®µ HTML / æµè§ˆå™¨å¿«ç…§ / base64 å›¾ç‰‡å¡å›å¯¹è¯ï¼Œä»£ç†ä¼šä¸»åŠ¨åˆ å‡ã€‚ä½ éœ€è¦æå‰çŸ¥é“å“ªäº›å†…å®¹ä¼šè¢«æ›¿æ¢æˆå ä½ç¬¦ï¼Œé¿å…è¯¯ä»¥ä¸ºæ¨¡å‹æ²¡çœ‹è§ã€‚

é‡ç‚¹è®°ä¸‰æ¡ï¼š

1. base64 å›¾ç‰‡ä¼šè¢«ç§»é™¤ï¼ˆæ”¹æˆæç¤ºæ–‡æœ¬ï¼‰
2. æµè§ˆå™¨å¿«ç…§ä¼šå˜æˆ head/tail æ‘˜è¦ï¼ˆå¸¦çœç•¥å­—ç¬¦æ•°ï¼‰
3. è¶…è¿‡ 200,000 å­—ç¬¦ä¼šè¢«æˆªæ–­å¹¶è¿½åŠ  `...[truncated ...]` æç¤º

**ä½ åº”è¯¥çœ‹åˆ°**ï¼šåœ¨ `tool_result_compressor.rs` é‡Œï¼Œè¿™äº›è§„åˆ™éƒ½æœ‰æ˜ç¡®çš„å¸¸é‡å’Œåˆ†æ”¯ï¼Œä¸æ˜¯å‡­ç»éªŒåˆ ã€‚

## æ£€æŸ¥ç‚¹

- ä½ èƒ½è¯´æ¸…æ¥š L1/L2/L3 çš„è§¦å‘ç‚¹æ¥è‡ª `proxy.experimental.context_compression_threshold_*`ï¼Œé»˜è®¤æ˜¯ `0.4/0.55/0.7`
- ä½ èƒ½è§£é‡Šä¸ºä»€ä¹ˆ Layer 2 ä¼š break cacheï¼šå› ä¸ºå®ƒä¼šä¿®æ”¹å†å² thinking æ–‡æœ¬å†…å®¹
- ä½ èƒ½è§£é‡Šä¸ºä»€ä¹ˆ Layer 3 å« Forkï¼šå®ƒä¼šæŠŠå¯¹è¯å˜æˆ XML æ‘˜è¦ + ç¡®è®¤ + æœ€æ–° user æ¶ˆæ¯çš„æ–°åºåˆ—
- ä½ èƒ½è¯´æ˜å·¥å…·ç»“æœå‹ç¼©ä¼šåˆ æ‰ base64 å›¾ç‰‡ï¼Œå¹¶æŠŠæµè§ˆå™¨å¿«ç…§æ”¹æˆ head/tail æ‘˜è¦

## è¸©å‘æé†’

| ç°è±¡ | å¯èƒ½åŸå›  | ä½ å¯ä»¥æ€ä¹ˆåš |
| --- | --- | --- |
| è§¦å‘äº† Layer 2 ä¹‹åæ„Ÿè§‰ä¸Šä¸‹æ–‡æ²¡é‚£ä¹ˆç¨³äº† | Layer 2 ä¼šä¿®æ”¹å†å²å†…å®¹ï¼Œæ³¨é‡Šé‡Œæ˜ç¡®å®ƒä¼š break cache | å¦‚æœä½ ä¾èµ– Prompt Cache çš„ä¸€è‡´æ€§ï¼Œå°½é‡è®© L1 å…ˆè§£å†³é—®é¢˜ï¼Œæˆ–æé«˜ L2 é˜ˆå€¼ |
| Layer 3 è§¦å‘åç›´æ¥è¿”å› 400 | Fork + æ‘˜è¦è°ƒç”¨åå°æ¨¡å‹å¤±è´¥ï¼ˆç½‘ç»œ/è´¦å·/ä¸Šæ¸¸é”™è¯¯ç­‰ï¼‰ | å…ˆæŒ‰é”™è¯¯ JSON é‡Œçš„å»ºè®®ç”¨ `/compact` æˆ– `/clear`ï¼›åŒæ—¶æ£€æŸ¥åå°æ¨¡å‹è°ƒç”¨é“¾è·¯ |
| å·¥å…·è¾“å‡ºé‡Œå›¾ç‰‡/å¤§æ®µå†…å®¹ä¸è§äº† | tool_result ä¼šç§»é™¤ base64 å›¾ç‰‡ã€æˆªæ–­è¶…é•¿è¾“å‡º | æŠŠé‡è¦å†…å®¹è½åˆ°æœ¬åœ°æ–‡ä»¶/é“¾æ¥é‡Œå†å¼•ç”¨ï¼›åˆ«æŒ‡æœ›æŠŠ 10 ä¸‡è¡Œæ–‡æœ¬ç›´æ¥å¡å›å¯¹è¯ |
| æ˜æ˜ç”¨çš„æ˜¯ Gemini æ¨¡å‹å´å¸¦äº† Claude ç­¾åå¯¼è‡´æŠ¥é”™ | ç­¾åè·¨æ¨¡å‹ä¸å…¼å®¹ï¼ˆä»£ç é‡Œæœ‰ family æ£€æŸ¥ï¼‰ | ç¡®è®¤ç­¾åæ¥æºï¼›å¿…è¦æ—¶è®©ä»£ç†åœ¨ retry åœºæ™¯ä¸‹å‰¥ç¦»å†å²ç­¾åï¼ˆè§è¯·æ±‚è½¬æ¢é€»è¾‘ï¼‰ |

## æœ¬è¯¾å°ç»“

- ä¸‰å±‚å‹ç¼©çš„æ ¸å¿ƒæ˜¯æŒ‰ä»£ä»·åˆ†çº§ï¼šå…ˆåˆ æ—§å·¥å…·è½®ï¼Œå†å‹ç¼©æ—§ Thinkingï¼Œæœ€åæ‰ Fork + XML æ‘˜è¦
- ç­¾åç¼“å­˜æ˜¯è®©å·¥å…·é“¾ä¸æ–­çš„å…³é”®ï¼šSession/Tool/Family ä¸‰å±‚å„ç®¡ä¸€ç±»é—®é¢˜ï¼ŒTTL æ˜¯ 2 å°æ—¶
- å·¥å…·ç»“æœå‹ç¼©æ˜¯é¿å…å·¥å…·è¾“å‡ºæŠŠä¸Šä¸‹æ–‡å¡çˆ†çš„ç¡¬é™åˆ¶ï¼š200,000 å­—ç¬¦ä¸Šé™ + å¿«ç…§/å¤§æ–‡ä»¶æç¤ºç‰¹åŒ–

## ä¸‹ä¸€è¯¾é¢„å‘Š

> ä¸‹ä¸€è¯¾æˆ‘ä»¬èŠç³»ç»Ÿèƒ½åŠ›ï¼šå¤šè¯­è¨€/ä¸»é¢˜/æ›´æ–°/å¼€æœºè‡ªå¯/HTTP API Serverã€‚

---

## é™„å½•ï¼šæºç å‚è€ƒ

<details>
<summary><strong>ç‚¹å‡»å±•å¼€æŸ¥çœ‹æºç ä½ç½®</strong></summary>

> æ›´æ–°æ—¶é—´ï¼š2026-01-23

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | è¡Œå· |
| --- | --- | --- |
| å®éªŒæ€§é…ç½®ï¼šå‹ç¼©é˜ˆå€¼ä¸å¼€å…³é»˜è®¤å€¼ | `src-tauri/src/proxy/config.rs` | 119-168 |
| ä¸Šä¸‹æ–‡ä¼°ç®—ï¼šå¤šè¯­è¨€å­—ç¬¦ä¼°ç®— + 15% ä½™é‡ | `src-tauri/src/proxy/mappers/context_manager.rs` | 9-37 |
| Token ç”¨é‡ä¼°ç®—ï¼šéå† system/messages/tools/thinking | `src-tauri/src/proxy/mappers/context_manager.rs` | 103-198 |
| Layer 1ï¼šè¯†åˆ«å·¥å…·è½® + è£å‰ªæ—§è½®æ¬¡ | `src-tauri/src/proxy/mappers/context_manager.rs` | 311-439 |
| Layer 2ï¼šThinking å‹ç¼©ä½†ä¿ç•™ç­¾åï¼ˆä¿æŠ¤æœ€è¿‘ N æ¡ï¼‰ | `src-tauri/src/proxy/mappers/context_manager.rs` | 200-271 |
| Layer 3 è¾…åŠ©ï¼šæå–æœ€åä¸€ä¸ªæœ‰æ•ˆç­¾å | `src-tauri/src/proxy/mappers/context_manager.rs` | 73-109 |
| åå°ä»»åŠ¡é™çº§ï¼šAggressive å‡€åŒ– Thinking block | `src-tauri/src/proxy/handlers/claude.rs` | 540-583 |
| ä¸‰å±‚å‹ç¼©ä¸»æµç¨‹ï¼šä¼°ç®—ã€æ ¡å‡†ã€æŒ‰é˜ˆå€¼è§¦å‘ L1/L2/L3 | `src-tauri/src/proxy/handlers/claude.rs` | 379-731 |
| Layer 3ï¼šXML æ‘˜è¦ + Fork ä¼šè¯å®ç° | `src-tauri/src/proxy/handlers/claude.rs` | 1560-1687 |
| ç­¾åç¼“å­˜ï¼šTTL/ä¸‰å±‚ç¼“å­˜ç»“æ„ï¼ˆTool/Family/Sessionï¼‰ | `src-tauri/src/proxy/signature_cache.rs` | 5-88 |
| ç­¾åç¼“å­˜ï¼šSession ç­¾åå†™å…¥/è¯»å– | `src-tauri/src/proxy/signature_cache.rs` | 141-223 |
| SSE æµå¼è§£æï¼šç¼“å­˜ thinking/tool çš„ signature åˆ° Session/Tool cache | `src-tauri/src/proxy/mappers/claude/streaming.rs` | 766-776 |
| SSE æµå¼è§£æï¼štool_use ç¼“å­˜ tool_use_id -> signature | `src-tauri/src/proxy/mappers/claude/streaming.rs` | 958-975 |
| è¯·æ±‚è½¬æ¢ï¼štool_use ä¼˜å…ˆä» Session/Tool cache è¡¥ç­¾å | `src-tauri/src/proxy/mappers/claude/request.rs` | 1045-1142 |
| è¯·æ±‚è½¬æ¢ï¼štool_result è§¦å‘å·¥å…·ç»“æœå‹ç¼© | `src-tauri/src/proxy/mappers/claude/request.rs` | 1159-1225 |
| å·¥å…·ç»“æœå‹ç¼©ï¼šå…¥å£ `compact_tool_result_text()` | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 28-69 |
| å·¥å…·ç»“æœå‹ç¼©ï¼šæµè§ˆå™¨å¿«ç…§ head/tail æ‘˜è¦ | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 123-178 |
| å·¥å…·ç»“æœå‹ç¼©ï¼šç§»é™¤ base64 å›¾ç‰‡ + æ€»å­—ç¬¦ä¸Šé™ | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 247-320 |
| æµ‹è¯•æ–¹æ¡ˆï¼šä¸‰å±‚å‹ç¼©è§¦å‘ä¸æ—¥å¿—éªŒè¯ | `docs/testing/context_compression_test_plan.md` | 1-116 |

</details>
