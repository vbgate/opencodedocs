---
title: "ä¸Šä¸‹æ–‡å£“ç¸®ï¼šç©©å®šé•·æœƒè©± | Antigravity-Manager"
sidebarTitle: "é•·æœƒè©±ä¸å´©"
subtitle: "ä¸Šä¸‹æ–‡å£“ç¸®ï¼šç©©å®šé•·æœƒè©±"
description: "å­¸ç¿’ Antigravity çš„ä¸‰å±¤ä¸Šä¸‹æ–‡å£“ç¸®æ©Ÿåˆ¶ã€‚é€éå·¥å…·è¼ªè£å‰ªã€Thinking å£“ç¸®èˆ‡ç°½åå¿«å–é™ä½ 400 éŒ¯èª¤èˆ‡ Prompt éé•·å¤±æ•—ã€‚"
tags:
  - "ä¸Šä¸‹æ–‡å£“ç¸®"
  - "ç°½åå¿«å–"
  - "Thinking"
  - "Tool Result"
  - "ç©©å®šæ€§"
prerequisite:
  - "start-proxy-and-first-client"
  - "advanced-monitoring"
order: 8
---

# é•·æœƒè©±ç©©å®šæ€§ï¼šä¸Šä¸‹æ–‡å£“ç¸®ã€ç°½åå¿«å–èˆ‡å·¥å…·çµæœå£“ç¸®

ä½ åœ¨ç”¨ Claude Code / Cherry Studio ä¹‹é¡çš„å®¢æˆ¶ç«¯è·‘é•·æœƒè©±æ™‚ï¼Œæœ€ç…©çš„ä¸æ˜¯æ¨¡å‹ä¸å¤ è°æ˜ï¼Œè€Œæ˜¯å°è©±è·‘è‘—è·‘è‘—çªç„¶é–‹å§‹å ±éŒ¯ï¼š`Prompt is too long`ã€400 ç°½åéŒ¯èª¤ã€å·¥å…·å‘¼å«éˆæ–·äº†ã€æˆ–è€…å·¥å…·è¿´åœˆè¶Šè·‘è¶Šå¡ã€‚

é€™ä¸€èª²æŠŠ Antigravity Tools ç‚ºé€™äº›å•é¡Œåšçš„ä¸‰ä»¶äº‹è¬›æ¸…æ¥šï¼šä¸Šä¸‹æ–‡å£“ç¸®ï¼ˆåˆ†ä¸‰å±¤é€æ­¥ä»‹å…¥ï¼‰ã€ç°½åå¿«å–ï¼ˆæŠŠ Thinking çš„ç°½åéˆçºŒä¸Šï¼‰ã€å·¥å…·çµæœå£“ç¸®ï¼ˆé¿å…å·¥å…·è¼¸å‡ºæŠŠä¸Šä¸‹æ–‡å¡çˆ†ï¼‰ã€‚

## å­¸å®Œä½ èƒ½åšä»€éº¼

- èªªæ¸…æ¥šä¸‰å±¤æ¼¸é€²å¼ä¸Šä¸‹æ–‡å£“ç¸®åˆ†åˆ¥åœ¨åšä»€éº¼ã€å„è‡ªçš„ä»£åƒ¹æ˜¯ä»€éº¼
- çŸ¥é“ç°½åå¿«å–å­˜äº†å“ªäº›æ±è¥¿ï¼ˆTool/Family/Session ä¸‰å±¤ï¼‰ä»¥åŠ 2 å°æ™‚ TTL çš„å½±éŸ¿
- ç†è§£å·¥å…·çµæœå£“ç¸®çš„è¦å‰‡ï¼šä½•æ™‚æœƒä¸Ÿæ‰ base64 åœ–ç‰‡ã€ä½•æ™‚æœƒæŠŠç€è¦½å™¨å¿«ç…§è®Šæˆé ­+å°¾æ‘˜è¦
- éœ€è¦æ™‚èƒ½é€é `proxy.experimental` çš„é–¾å€¼é–‹é—œèª¿ç¯€å£“ç¸®è§¸ç™¼æ™‚æ©Ÿ

## ä½ ç¾åœ¨çš„å›°å¢ƒ

- é•·å°è©±å¾Œçªç„¶é–‹å§‹ 400ï¼šçœ‹èµ·ä¾†åƒç°½åå¤±æ•ˆï¼Œä½†ä½ ä¸çŸ¥é“ç°½åå¾å“ªä¾†ã€ä¸Ÿåœ¨å“ª
- å·¥å…·å‘¼å«è¶Šä¾†è¶Šå¤šï¼Œæ­·å² tool_result å †åˆ°ä¸Šæ¸¸ç›´æ¥æ‹’çµ•ï¼ˆæˆ–è®Šå¾—æ¥µæ…¢ï¼‰
- ä½ æƒ³ç”¨å£“ç¸®æ•‘å ´ï¼Œä½†åˆæ“”å¿ƒç ´å£ Prompt Cacheã€å½±éŸ¿ä¸€è‡´æ€§æˆ–è®“æ¨¡å‹ä¸Ÿè³‡è¨Š

## ä»€éº¼æ™‚å€™ç”¨é€™ä¸€æ‹›

- ä½ åœ¨è·‘é•·éˆè·¯å·¥å…·ä»»å‹™ï¼ˆæœå°‹/è®€æª”æ¡ˆ/ç€è¦½å™¨å¿«ç…§/å¤šè¼ªå·¥å…·è¿´åœˆï¼‰
- ä½ åœ¨ç”¨ Thinking æ¨¡å‹åšè¤‡é›œæ¨ç†ï¼Œä¸”æœƒè©±ç¶“å¸¸è¶…éå¹¾åè¼ª
- ä½ åœ¨æ’æŸ¥å®¢æˆ¶ç«¯èƒ½é‡ç¾ä½†ä½ èªªä¸æ¸…ç‚ºä»€éº¼çš„ç©©å®šæ€§å•é¡Œ

## ä»€éº¼æ˜¯ä¸Šä¸‹æ–‡å£“ç¸®

**ä¸Šä¸‹æ–‡å£“ç¸®**æ˜¯ä»£ç†åœ¨åµæ¸¬åˆ°ä¸Šä¸‹æ–‡å£“åŠ›éé«˜æ™‚ï¼Œå°æ­·å²è¨Šæ¯åšçš„è‡ªå‹•é™å™ªèˆ‡ç˜¦èº«ï¼šå…ˆè£æ‰èˆŠçš„å·¥å…·è¼ªï¼Œå†æŠŠèˆŠçš„ Thinking æ–‡å­—å£“æˆä½”ä½ç¬¦ä½†ä¿ç•™ç°½åï¼Œæœ€å¾Œåœ¨æ¥µç«¯æƒ…æ³ä¸‹ç”Ÿæˆ XML æ‘˜è¦ä¸¦ Fork ä¸€å€‹æ–°æœƒè©±ç¹¼çºŒå°è©±ï¼Œå¾è€Œé™ä½ `Prompt is too long` å’Œç°½åéˆæ–·è£‚å°è‡´çš„å¤±æ•—ã€‚

::: info ä¸Šä¸‹æ–‡å£“åŠ›æ˜¯æ€éº¼è¨ˆç®—çš„ï¼Ÿ
Claude è™•ç†å™¨æœƒç”¨ `ContextManager::estimate_token_usage()` åšä¸€å€‹è¼•é‡ä¼°ç®—ï¼Œä¸¦ç”¨ `estimation_calibrator` æ ¡æº–ï¼Œç„¶å¾Œç”¨ `usage_ratio = estimated_usage / context_limit` å¾—åˆ°å£“åŠ›ç™¾åˆ†æ¯”ï¼ˆæ—¥èªŒè£¡æœƒåˆ—å° raw/calibrated å€¼ï¼‰ã€‚
:::

## ğŸ’ é–‹å§‹å‰çš„æº–å‚™

- ä½ å·²ç¶“è·‘é€šæœ¬åœ°ä»£ç†ï¼Œä¸¦ä¸”å®¢æˆ¶ç«¯ç¢ºå¯¦åœ¨èµ° `/v1/messages` é€™æ¢éˆè·¯ï¼ˆè¦‹å•Ÿå‹•æœ¬åœ°åä»£ä¸¦æ¥å…¥ç¬¬ä¸€å€‹å®¢æˆ¶ç«¯ï¼‰
- ä½ èƒ½æª¢è¦–ä»£ç†æ—¥èªŒï¼ˆé–‹ç™¼è€…é™¤éŒ¯æˆ–æœ¬åœ°æ—¥èªŒæª”æ¡ˆï¼‰ã€‚å€‰åº«è£¡çš„æ¸¬è©¦æ–¹æ¡ˆçµ¦äº†ä¸€å€‹ç¯„ä¾‹æ—¥èªŒè·¯å¾‘èˆ‡ grep æ–¹å¼ï¼ˆè¦‹ `docs/testing/context_compression_test_plan.md`ï¼‰

::: tip é…åˆ Proxy Monitor æ›´å¥½å®šä½
å¦‚æœä½ è¦æŠŠå£“ç¸®è§¸ç™¼èˆ‡å“ªé¡è«‹æ±‚/å“ªå€‹å¸³è™Ÿ/å“ªè¼ªå·¥å…·å‘¼å«å°ä¸Šè™Ÿï¼Œå»ºè­°åŒæ™‚é–‹è‘— Proxy Monitorã€‚
:::

## æ ¸å¿ƒæ€è·¯

é€™å¥—ç©©å®šæ€§è¨­è¨ˆä¸æ˜¯ç›´æ¥æŠŠæ­·å²å…¨åˆªäº†ï¼Œè€Œæ˜¯æŒ‰ä»£åƒ¹å¾ä½åˆ°é«˜é€å±¤ä»‹å…¥ï¼š

| å±¤ç´š | è§¸ç™¼é»ï¼ˆå¯é…ç½®ï¼‰ | åšäº†ä»€éº¼ | ä»£åƒ¹/å‰¯ä½œç”¨ |
|--- | --- | --- | ---|
| Layer 1 | `proxy.experimental.context_compression_threshold_l1`ï¼ˆé è¨­ 0.4ï¼‰ | è­˜åˆ¥å·¥å…·è¼ªï¼Œåªä¿ç•™æœ€è¿‘ N è¼ªï¼ˆç¨‹å¼ç¢¼è£¡æ˜¯ 5ï¼‰ï¼ŒæŠŠæ›´æ—©çš„ tool_use/tool_result å°åˆªæ‰ | ä¸æ”¹å‰©é¤˜è¨Šæ¯å…§å®¹ï¼Œå° Prompt Cache æ›´å‹å–„ |
| Layer 2 | `proxy.experimental.context_compression_threshold_l2`ï¼ˆé è¨­ 0.55ï¼‰ | æŠŠèˆŠçš„ Thinking æ–‡å­—å£“æˆ `"..."`ï¼Œä½†ä¿ç•™ `signature`ï¼Œä¸¦ä¿è­·æœ€è¿‘ 4 æ¢è¨Šæ¯ä¸å‹• | æœƒä¿®æ”¹æ­·å²å…§å®¹ï¼Œè¨»é‡‹è£¡æ˜ç¢ºæœƒ break cacheï¼Œä½†èƒ½ä¿ä½ç°½åéˆ |
| Layer 3 | `proxy.experimental.context_compression_threshold_l3`ï¼ˆé è¨­ 0.7ï¼‰ | å‘¼å«å¾Œå°æ¨¡å‹ç”Ÿæˆ XML æ‘˜è¦ï¼Œç„¶å¾Œ Fork ä¸€å€‹æ–°è¨Šæ¯åºåˆ—ç¹¼çºŒå°è©± | ä¾è³´å¾Œå°æ¨¡å‹å‘¼å«ï¼›è‹¥å¤±æ•—æœƒè¿”å› 400ï¼ˆæœ‰å‹å–„æç¤ºï¼‰ |

æ¥ä¸‹ä¾†æŒ‰ä¸‰å±¤æ‹†é–‹è¬›ï¼Œé †ä¾¿æŠŠç°½åå¿«å–å’Œå·¥å…·çµæœå£“ç¸®æ”¾åœ¨ä¸€èµ·ã€‚

### Layer 1ï¼šå·¥å…·è¼ªè£å‰ªï¼ˆTrim Tool Messagesï¼‰

Layer 1 çš„é—œéµé»æ˜¯åªåˆªæ•´è¼ªå·¥å…·äº’å‹•ï¼Œé¿å…åŠåˆªå°è‡´ä¸Šä¸‹æ–‡ä¸ä¸€è‡´ã€‚

- ä¸€è¼ªå·¥å…·äº’å‹•çš„è­˜åˆ¥è¦å‰‡åœ¨ `identify_tool_rounds()`ï¼š`assistant` è£¡å‡ºç¾ `tool_use` é–‹å§‹ä¸€è¼ªï¼Œå¾ŒçºŒ `user` è£¡å‡ºç¾ `tool_result` ä»ç®—é€™ä¸€è¼ªï¼Œç›´åˆ°é‡åˆ°æ™®é€š user æ–‡å­—çµæŸé€™ä¸€è¼ªã€‚
- çœŸæ­£åŸ·è¡Œè£å‰ªçš„æ˜¯ `ContextManager::trim_tool_messages(&mut messages, 5)`ï¼šç•¶æ­·å²å·¥å…·è¼ªè¶…é 5 è¼ªæ™‚ï¼Œåˆªæ‰æ›´æ—©çš„è¼ªæ¬¡è£¡æ¶‰åŠçš„è¨Šæ¯ã€‚

### Layer 2ï¼šThinking å£“ç¸®ä½†ä¿ç•™ç°½å

å¾ˆå¤š 400 å•é¡Œä¸¦ä¸æ˜¯ Thinking å¤ªé•·ï¼Œè€Œæ˜¯ Thinking çš„ç°½åéˆæ–·äº†ã€‚Layer 2 çš„ç­–ç•¥æ˜¯ï¼š

- åªè™•ç† `assistant` è¨Šæ¯è£¡çš„ `ContentBlock::Thinking { thinking, signature, .. }`
- åªæœ‰åœ¨ `signature.is_some()` ä¸” `thinking.len() > 10` æ™‚æ‰å£“ç¸®ï¼ŒæŠŠ `thinking` ç›´æ¥æ”¹æˆ `"..."`
- æœ€è¿‘ `protected_last_n = 4` æ¢è¨Šæ¯ä¸å£“ç¸®ï¼ˆå¤§è‡´æ˜¯æœ€è¿‘ 2 è¼ª user/assistantï¼‰

é€™æ¨£å¯ä»¥çœæ‰å¤§é‡ Tokenï¼Œä½†ä»æŠŠ `signature` ç•™åœ¨æ­·å²è£¡ï¼Œé¿å…å·¥å…·éˆéœ€è¦å›å¡«ç°½åæ™‚ç„¡å¾æ¢å¾©ã€‚

### Layer 3ï¼šFork + XML æ‘˜è¦ï¼ˆæ¥µé™å…œåº•ï¼‰

ç•¶å£“åŠ›ç¹¼çºŒå‡é«˜æ™‚ï¼ŒClaude è™•ç†å™¨æœƒå˜—è©¦é‡é–‹æœƒè©±ä½†ä¸ä¸Ÿé—œéµè³‡è¨Šï¼š

1. å¾åŸå§‹è¨Šæ¯è£¡æ“·å–æœ€å¾Œä¸€å€‹æœ‰æ•ˆçš„ Thinking ç°½åï¼ˆ`ContextManager::extract_last_valid_signature()`ï¼‰
2. æŠŠæ•´å€‹æ­·å² + `CONTEXT_SUMMARY_PROMPT` æ‹¼æˆä¸€å€‹ç”Ÿæˆ XML æ‘˜è¦çš„è«‹æ±‚ï¼Œæ¨¡å‹å›ºå®šç‚º `BACKGROUND_MODEL_LITE`ï¼ˆç•¶å‰ç¨‹å¼ç¢¼æ˜¯ `gemini-2.5-flash`ï¼‰
3. æ‘˜è¦è£¡è¦æ±‚åŒ…å« `<latest_thinking_signature>`ï¼Œç”¨æ–¼å¾ŒçºŒç°½åéˆå»¶çºŒ
4. Fork å‡ºä¸€å€‹æ–°è¨Šæ¯åºåˆ—ï¼š
   - `User: Context has been compressed... + XML summary`
   - `Assistant: I have reviewed...`
   - å†é™„ä¸ŠåŸè«‹æ±‚æœ€å¾Œä¸€æ¢ user è¨Šæ¯ï¼ˆå¦‚æœå®ƒä¸æ˜¯å‰›å‰›çš„æ‘˜è¦æŒ‡ä»¤ï¼‰

å¦‚æœ Fork + æ‘˜è¦å¤±æ•—ï¼Œæœƒç›´æ¥è¿”å› `StatusCode::BAD_REQUEST`ï¼Œä¸¦æç¤ºä½ ç”¨ `/compact` æˆ– `/clear` ç­‰æ–¹å¼æ‰‹å‹•è™•ç†ï¼ˆè¦‹è™•ç†å™¨è¿”å›çš„ error JSONï¼‰ã€‚

### æ—è·¯ 1ï¼šä¸‰å±¤ç°½åå¿«å–ï¼ˆTool / Family / Sessionï¼‰

ç°½åå¿«å–æ˜¯ä¸Šä¸‹æ–‡å£“ç¸®çš„ä¿éšªçµ²ï¼Œå°¤å…¶æ˜¯å®¢æˆ¶ç«¯æœƒè£å‰ª/ä¸Ÿæ£„ç°½åå­—æ®µæ™‚ã€‚

- TTLï¼š`SIGNATURE_TTL = 2 * 60 * 60`ï¼ˆ2 å°æ™‚ï¼‰
- Layer 1ï¼š`tool_use_id -> signature`ï¼ˆå·¥å…·éˆæ¢å¾©ï¼‰
- Layer 2ï¼š`signature -> model family`ï¼ˆè·¨æ¨¡å‹ç›¸å®¹æ€§æª¢æŸ¥ï¼Œé¿å… Claude ç°½åè¢«å¸¶åˆ° Gemini å®¶æ—æ¨¡å‹ä¸Šï¼‰
- Layer 3ï¼š`session_id -> latest signature`ï¼ˆæœƒè©±ç´šéš”é›¢ï¼Œé¿å…ä¸åŒå°è©±æ±¡æŸ“ï¼‰

é€™ä¸‰å±¤å¿«å–æœƒåœ¨ Claude SSE ä¸²æµè§£æèˆ‡è«‹æ±‚è½‰æ›æ™‚è¢«å¯«å…¥/è®€å–ï¼š

- ä¸²æµè§£æåˆ° thinking çš„ `signature` æœƒå¯«å…¥ Session Cacheï¼ˆä»¥åŠå¿«å– familyï¼‰
- ä¸²æµè§£æåˆ° tool_use çš„ `signature` æœƒå¯«å…¥ Tool Cache + Session Cache
- åœ¨æŠŠ Claude å·¥å…·å‘¼å«è½‰æ›ç‚º Gemini `functionCall` æ™‚ï¼Œæœƒå„ªå…ˆå¾ Session Cache æˆ– Tool Cache æŠŠç°½åè£œå›å»

### æ—è·¯ 2ï¼šå·¥å…·çµæœå£“ç¸®ï¼ˆTool Result Compressorï¼‰

å·¥å…·çµæœå¾€å¾€æ¯”èŠå¤©æ–‡å­—æ›´å®¹æ˜“æŠŠä¸Šä¸‹æ–‡å¡çˆ†ï¼Œæ‰€ä»¥è«‹æ±‚è½‰æ›éšæ®µæœƒå° tool_result åšå¯é æœŸçš„åˆªæ¸›ã€‚

æ ¸å¿ƒè¦å‰‡ï¼ˆéƒ½åœ¨ `tool_result_compressor.rs`ï¼‰ï¼š

- ç¸½å­—å…ƒä¸Šé™ï¼š`MAX_TOOL_RESULT_CHARS = 200_000`
- base64 åœ–ç‰‡å¡Šç›´æ¥ç§»é™¤ï¼ˆè¿½åŠ ä¸€æ®µæç¤ºæ–‡å­—ï¼‰
- å¦‚æœåµæ¸¬åˆ°è¼¸å‡ºå·²å„²å­˜åˆ°æª”æ¡ˆçš„æç¤ºï¼Œæœƒæ“·å–é—œéµè³‡è¨Šä¸¦ç”¨ `[tool_result omitted ...]` ä½”ä½
- å¦‚æœåµæ¸¬åˆ°ç€è¦½å™¨å¿«ç…§ï¼ˆåŒ…å« `page snapshot` / `ref=` ç­‰ç‰¹å¾µï¼‰ï¼Œæœƒæ”¹æˆé ­ + å°¾æ‘˜è¦ï¼Œä¸¦æ¨™è¨»çœç•¥äº†å¤šå°‘å­—å…ƒ
- å¦‚æœè¼¸å…¥åƒ HTMLï¼Œæœƒå…ˆç§»é™¤ `<style>`/`<script>`/base64 ç‰‡æ®µå†åšæˆªæ–·

## è·Ÿæˆ‘åš

### ç¬¬ 1 æ­¥ï¼šç¢ºèªå£“ç¸®é–¾å€¼ï¼ˆä»¥åŠé è¨­å€¼ï¼‰

**ç‚ºä»€éº¼**
å£“ç¸®è§¸ç™¼é»ä¸æ˜¯å¯«æ­»çš„ï¼Œä¾†è‡ª `proxy.experimental.*`ã€‚ä½ å¾—å…ˆçŸ¥é“ç›®å‰é–¾å€¼ï¼Œæ‰èƒ½åˆ¤æ–·ç‚ºä»€éº¼å®ƒé€™éº¼æ—©/é€™éº¼æ™šæ‰ä»‹å…¥ã€‚

é è¨­å€¼ï¼ˆRust å´ `ExperimentalConfig::default()`ï¼‰ï¼š

```json
{
  "proxy": {
    "experimental": {
      "enable_signature_cache": true,
      "enable_tool_loop_recovery": true,
      "enable_cross_model_checks": true,
      "enable_usage_scaling": true,
      "context_compression_threshold_l1": 0.4,
      "context_compression_threshold_l2": 0.55,
      "context_compression_threshold_l3": 0.7
    }
  }
}
```

**ä½ æ‡‰è©²çœ‹åˆ°**ï¼šä½ çš„è¨­å®šè£¡å­˜åœ¨ `proxy.experimental`ï¼ˆæ¬„ä½åèˆ‡ä¸Šé¢ä¸€è‡´ï¼‰ï¼Œä¸¦ä¸”é–¾å€¼æ˜¯ `0.x` é€™æ¨£çš„æ¯”ä¾‹å€¼ã€‚

::: warning è¨­å®šæª”ä½ç½®ä¸åœ¨é€™ä¸€èª²é‡è¤‡è¬›
è¨­å®šæª”çš„è½ç›¤ä½ç½®èˆ‡ä¿®æ”¹å¾Œæ˜¯å¦éœ€è¦é‡å•Ÿï¼Œå±¬æ–¼è¨­å®šç®¡ç†ç¯„ç–‡ã€‚æŒ‰é€™å¥—æ•™å­¸é«”ç³»ï¼Œå„ªå…ˆä»¥è¨­å®šå…¨è§£ï¼šAppConfig/ProxyConfigã€è½ç›¤ä½ç½®èˆ‡ç†±æ›´æ–°èªç¾©ç‚ºæº–ã€‚
:::

### ç¬¬ 2 æ­¥ï¼šç”¨æ—¥èªŒç¢ºèª Layer 1/2/3 æ˜¯å¦è§¸ç™¼

**ç‚ºä»€éº¼**
é€™ä¸‰å±¤éƒ½æ˜¯ä»£ç†å…§éƒ¨è¡Œç‚ºï¼Œæœ€å¯é çš„é©—è­‰æ–¹å¼æ˜¯çœ‹æ—¥èªŒè£¡æ˜¯å¦å‡ºç¾ `[Layer-1]` / `[Layer-2]` / `[Layer-3]`ã€‚

å€‰åº«çš„æ¸¬è©¦æ–¹æ¡ˆçµ¦äº†ä¸€å€‹ç¯„ä¾‹æŒ‡ä»¤ï¼ˆæŒ‰éœ€èª¿æ•´ç‚ºä½ æ©Ÿå™¨ä¸Šçš„å¯¦éš›æ—¥èªŒè·¯å¾‘ï¼‰ï¼š

```bash
tail -f ~/Library/Application\ Support/com.antigravity.tools/logs/antigravity.log | grep -E "Layer-[123]"
```

**ä½ æ‡‰è©²çœ‹åˆ°**ï¼šç•¶å£“åŠ›å‡é«˜æ™‚ï¼Œæ—¥èªŒå‡ºç¾é¡ä¼¼ `Tool trimming triggered`ã€`Thinking compression triggered`ã€`Fork successful` çš„è¨˜éŒ„ï¼ˆå…·é«”æ¬„ä½ä»¥æ—¥èªŒåŸæ–‡ç‚ºæº–ï¼‰ã€‚

### ç¬¬ 3 æ­¥ï¼šç†è§£æ·¨åŒ–å’Œå£“ç¸®çš„å·®åˆ¥ï¼ˆä¸è¦æ··ç”¨é æœŸï¼‰

**ç‚ºä»€éº¼**
æœ‰äº›å•é¡Œï¼ˆæ¯”å¦‚å¼·åˆ¶é™ç´šåˆ°ä¸æ”¯æ´ Thinking çš„æ¨¡å‹ï¼‰éœ€è¦æ·¨åŒ–è€Œä¸æ˜¯å£“ç¸®ã€‚æ·¨åŒ–æœƒç›´æ¥åˆªæ‰ Thinking blockï¼›å£“ç¸®æœƒä¿ç•™ç°½åéˆã€‚

åœ¨ Claude è™•ç†å™¨è£¡ï¼Œå¾Œå°ä»»å‹™é™ç´šæœƒèµ° `ContextManager::purify_history(..., PurificationStrategy::Aggressive)`ï¼Œå®ƒæœƒæŠŠæ­·å² Thinking block ç›´æ¥ç§»é™¤ã€‚

**ä½ æ‡‰è©²çœ‹åˆ°**ï¼šä½ èƒ½å€åˆ†å…©é¡è¡Œç‚ºï¼š

- æ·¨åŒ–æ˜¯åˆªæ‰ Thinking block
- Layer 2 å£“ç¸®æ˜¯æŠŠèˆŠ Thinking æ–‡å­—æ›¿æ›æˆ `"..."`ï¼Œä½†ç°½åé‚„åœ¨

### ç¬¬ 4 æ­¥ï¼šç•¶ä½ é‡åˆ° 400 ç°½åéŒ¯èª¤ï¼Œå…ˆçœ‹ Session Cache æ˜¯å¦å‘½ä¸­

**ç‚ºä»€éº¼**
å¾ˆå¤š 400 çš„æ ¹å› ä¸æ˜¯æ²’æœ‰ç°½åï¼Œè€Œæ˜¯ç°½åæ²’è·Ÿè‘—è¨Šæ¯èµ°ã€‚è«‹æ±‚è½‰æ›æ™‚æœƒå„ªå…ˆå¾ Session Cache è£œç°½åã€‚

ç·šç´¢ï¼ˆè«‹æ±‚è½‰æ›éšæ®µçš„æ—¥èªŒæœƒæç¤ºå¾ SESSION/TOOL cache æ¢å¾©ç°½åï¼‰ï¼š

- `[Claude-Request] Recovered signature from SESSION cache ...`
- `[Claude-Request] Recovered signature from TOOL cache ...`

**ä½ æ‡‰è©²çœ‹åˆ°**ï¼šç•¶å®¢æˆ¶ç«¯ä¸Ÿç°½åä½†ä»£ç†å¿«å–é‚„åœ¨æ™‚ï¼Œæ—¥èªŒè£¡æœƒå‡ºç¾ Recovered signature from ... cache çš„è¨˜éŒ„ã€‚

### ç¬¬ 5 æ­¥ï¼šç†è§£å·¥å…·çµæœå£“ç¸®çš„æœƒä¸Ÿä»€éº¼

**ç‚ºä»€éº¼**
å¦‚æœä½ è®“å·¥å…·æŠŠå¤§æ®µ HTML / ç€è¦½å™¨å¿«ç…§ / base64 åœ–ç‰‡å¡å›å°è©±ï¼Œä»£ç†æœƒä¸»å‹•åˆªæ¸›ã€‚ä½ éœ€è¦æå‰çŸ¥é“å“ªäº›å…§å®¹æœƒè¢«æ›¿æ›æˆä½”ä½ç¬¦ï¼Œé¿å…èª¤ä»¥ç‚ºæ¨¡å‹æ²’çœ‹è¦‹ã€‚

é‡é»è¨˜ä¸‰æ¢ï¼š

1. base64 åœ–ç‰‡æœƒè¢«ç§»é™¤ï¼ˆæ”¹æˆæç¤ºæ–‡å­—ï¼‰
2. ç€è¦½å™¨å¿«ç…§æœƒè®Šæˆ head/tail æ‘˜è¦ï¼ˆå¸¶çœç•¥å­—å…ƒæ•¸ï¼‰
3. è¶…é 200,000 å­—å…ƒæœƒè¢«æˆªæ–·ä¸¦è¿½åŠ  `...[truncated ...]` æç¤º

**ä½ æ‡‰è©²çœ‹åˆ°**ï¼šåœ¨ `tool_result_compressor.rs` è£¡ï¼Œé€™äº›è¦å‰‡éƒ½æœ‰æ˜ç¢ºçš„å¸¸æ•¸å’Œåˆ†æ”¯ï¼Œä¸æ˜¯æ†‘ç¶“é©—åˆªã€‚

## æª¢æŸ¥é»

- ä½ èƒ½èªªæ¸…æ¥š L1/L2/L3 çš„è§¸ç™¼é»ä¾†è‡ª `proxy.experimental.context_compression_threshold_*`ï¼Œé è¨­æ˜¯ `0.4/0.55/0.7`
- ä½ èƒ½è§£é‡‹ç‚ºä»€éº¼ Layer 2 æœƒ break cacheï¼šå› ç‚ºå®ƒæœƒä¿®æ”¹æ­·å² thinking æ–‡å­—å…§å®¹
- ä½ èƒ½è§£é‡‹ç‚ºä»€éº¼ Layer 3 å« Forkï¼šå®ƒæœƒæŠŠå°è©±è®Šæˆ XML æ‘˜è¦ + ç¢ºèª + æœ€æ–° user è¨Šæ¯çš„æ–°åºåˆ—
- ä½ èƒ½èªªæ˜å·¥å…·çµæœå£“ç¸®æœƒåˆªæ‰ base64 åœ–ç‰‡ï¼Œä¸¦æŠŠç€è¦½å™¨å¿«ç…§æ”¹æˆ head/tail æ‘˜è¦

## è¸©å‘æé†’

| ç¾è±¡ | å¯èƒ½åŸå›  | ä½ å¯ä»¥æ€éº¼åš |
|--- | --- | ---|
| è§¸ç™¼äº† Layer 2 ä¹‹å¾Œæ„Ÿè¦ºä¸Šä¸‹æ–‡æ²’é‚£éº¼ç©©äº† | Layer 2 æœƒä¿®æ”¹æ­·å²å…§å®¹ï¼Œè¨»é‡‹è£¡æ˜ç¢ºå®ƒæœƒ break cache | å¦‚æœä½ ä¾è³´ Prompt Cache çš„ä¸€è‡´æ€§ï¼Œç›¡é‡è®“ L1 å…ˆè§£æ±ºå•é¡Œï¼Œæˆ–æé«˜ L2 é–¾å€¼ |
| Layer 3 è§¸ç™¼å¾Œç›´æ¥è¿”å› 400 | Fork + æ‘˜è¦å‘¼å«å¾Œå°æ¨¡å‹å¤±æ•—ï¼ˆç¶²è·¯/å¸³è™Ÿ/ä¸Šæ¸¸éŒ¯èª¤ç­‰ï¼‰ | å…ˆæŒ‰éŒ¯èª¤ JSON è£¡çš„å»ºè­°ç”¨ `/compact` æˆ– `/clear`ï¼›åŒæ™‚æª¢æŸ¥å¾Œå°æ¨¡å‹å‘¼å«éˆè·¯ |
| å·¥å…·è¼¸å‡ºè£¡åœ–ç‰‡/å¤§æ®µå…§å®¹ä¸è¦‹äº† | tool_result æœƒç§»é™¤ base64 åœ–ç‰‡ã€æˆªæ–·è¶…é•·è¼¸å‡º | æŠŠé‡è¦å…§å®¹è½åˆ°æœ¬åœ°æª”æ¡ˆ/é€£çµè£¡å†å¼•ç”¨ï¼›åˆ¥æŒ‡æœ›æŠŠ 10 è¬è¡Œæ–‡å­—ç›´æ¥å¡å›å°è©± |
| æ˜æ˜ç”¨çš„æ˜¯ Gemini æ¨¡å‹å»å¸¶äº† Claude ç°½åå°è‡´å ±éŒ¯ | ç°½åè·¨æ¨¡å‹ä¸ç›¸å®¹ï¼ˆç¨‹å¼ç¢¼è£¡æœ‰ family æª¢æŸ¥ï¼‰ | ç¢ºèªç°½åä¾†æºï¼›å¿…è¦æ™‚è®“ä»£ç†åœ¨ retry å ´æ™¯ä¸‹å‰é›¢æ­·å²ç°½åï¼ˆè¦‹è«‹æ±‚è½‰æ›é‚è¼¯ï¼‰ |

## æœ¬èª²å°çµ

- ä¸‰å±¤å£“ç¸®çš„æ ¸å¿ƒæ˜¯æŒ‰ä»£åƒ¹åˆ†ç´šï¼šå…ˆåˆªèˆŠå·¥å…·è¼ªï¼Œå†å£“ç¸®èˆŠ Thinkingï¼Œæœ€å¾Œæ‰ Fork + XML æ‘˜è¦
- ç°½åå¿«å–æ˜¯è®“å·¥å…·éˆä¸æ–·çš„é—œéµï¼šSession/Tool/Family ä¸‰å±¤å„ç®¡ä¸€é¡å•é¡Œï¼ŒTTL æ˜¯ 2 å°æ™‚
- å·¥å…·çµæœå£“ç¸®æ˜¯é¿å…å·¥å…·è¼¸å‡ºæŠŠä¸Šä¸‹æ–‡å¡çˆ†çš„ç¡¬é™åˆ¶ï¼š200,000 å­—å…ƒä¸Šé™ + å¿«ç…§/å¤§æª”æ¡ˆæç¤ºç‰¹åŒ–

## ä¸‹ä¸€èª²é å‘Š

> ä¸‹ä¸€èª²æˆ‘å€‘èŠç³»çµ±èƒ½åŠ›ï¼šå¤šèªè¨€/ä¸»é¡Œ/æ›´æ–°/é–‹æ©Ÿè‡ªå•Ÿ/HTTP API Serverã€‚

---

## é™„éŒ„ï¼šåŸå§‹ç¢¼åƒè€ƒ

<details>
<summary><strong>é»æ“Šå±•é–‹æŸ¥çœ‹åŸå§‹ç¢¼ä½ç½®</strong></summary>

> æ›´æ–°æ™‚é–“ï¼š2026-01-23

| åŠŸèƒ½ | æª”æ¡ˆè·¯å¾‘ | è¡Œè™Ÿ |
|--- | --- | ---|
| å¯¦é©—æ€§è¨­å®šï¼šå£“ç¸®é–¾å€¼èˆ‡é–‹é—œé è¨­å€¼ | `src-tauri/src/proxy/config.rs` | 119-168 |
| ä¸Šä¸‹æ–‡ä¼°ç®—ï¼šå¤šèªè¨€å­—å…ƒä¼°ç®— + 15% é¤˜é‡ | `src-tauri/src/proxy/mappers/context_manager.rs` | 9-37 |
| Token ç”¨é‡ä¼°ç®—ï¼šéæ­· system/messages/tools/thinking | `src-tauri/src/proxy/mappers/context_manager.rs` | 103-198 |
| Layer 1ï¼šè­˜åˆ¥å·¥å…·è¼ª + è£å‰ªèˆŠè¼ªæ¬¡ | `src-tauri/src/proxy/mappers/context_manager.rs` | 311-439 |
| Layer 2ï¼šThinking å£“ç¸®ä½†ä¿ç•™ç°½åï¼ˆä¿è­·æœ€è¿‘ N æ¢ï¼‰ | `src-tauri/src/proxy/mappers/context_manager.rs` | 200-271 |
| Layer 3 è¼”åŠ©ï¼šæ“·å–æœ€å¾Œä¸€å€‹æœ‰æ•ˆç°½å | `src-tauri/src/proxy/mappers/context_manager.rs` | 73-109 |
| å¾Œå°ä»»å‹™é™ç´šï¼šAggressive æ·¨åŒ– Thinking block | `src-tauri/src/proxy/handlers/claude.rs` | 540-583 |
| ä¸‰å±¤å£“ç¸®ä¸»æµç¨‹ï¼šä¼°ç®—ã€æ ¡æº–ã€æŒ‰é–¾å€¼è§¸ç™¼ L1/L2/L3 | `src-tauri/src/proxy/handlers/claude.rs` | 379-731 |
| Layer 3ï¼šXML æ‘˜è¦ + Fork æœƒè©±å¯¦ä½œ | `src-tauri/src/proxy/handlers/claude.rs` | 1560-1687 |
| ç°½åå¿«å–ï¼šTTL/ä¸‰å±¤å¿«å–çµæ§‹ï¼ˆTool/Family/Sessionï¼‰ | `src-tauri/src/proxy/signature_cache.rs` | 5-88 |
| ç°½åå¿«å–ï¼šSession ç°½åå¯«å…¥/è®€å– | `src-tauri/src/proxy/signature_cache.rs` | 141-223 |
| SSE ä¸²æµè§£æï¼šå¿«å– thinking/tool çš„ signature åˆ° Session/Tool cache | `src-tauri/src/proxy/mappers/claude/streaming.rs` | 766-776 |
|--- | --- | ---|
| è«‹æ±‚è½‰æ›ï¼štool_use å„ªå…ˆå¾ Session/Tool cache è£œç°½å | `src-tauri/src/proxy/mappers/claude/request.rs` | 1045-1142 |
| è«‹æ±‚è½‰æ›ï¼štool_result è§¸ç™¼å·¥å…·çµæœå£“ç¸® | `src-tauri/src/proxy/mappers/claude/request.rs` | 1159-1225 |
| å·¥å…·çµæœå£“ç¸®ï¼šå…¥å£ `compact_tool_result_text()` | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 28-69 |
| å·¥å…·çµæœå£“ç¸®ï¼šç€è¦½å™¨å¿«ç…§ head/tail æ‘˜è¦ | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 123-178 |
| å·¥å…·çµæœå£“ç¸®ï¼šç§»é™¤ base64 åœ–ç‰‡ + ç¸½å­—å…ƒä¸Šé™ | `src-tauri/src/proxy/mappers/tool_result_compressor.rs` | 247-320 |
| æ¸¬è©¦æ–¹æ¡ˆï¼šä¸‰å±¤å£“ç¸®è§¸ç™¼èˆ‡æ—¥èªŒé©—è­‰ | `docs/testing/context_compression_test_plan.md` | 1-116 |

</details>
